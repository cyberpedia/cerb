# Maintenance Mode Configuration for Nginx
# Include this in your main nginx.conf to enable maintenance mode support

# Map to check if maintenance file exists
map $uri $maintenance {
    default 0;
    ~^/maintenance\.html$ 0;
}

# Check for maintenance flag file
map $uri $maintenance_mode {
    default 0;
    ~.* 1;
}

# Server block with maintenance mode support
server {
    listen 80;
    server_name ctf.com www.ctf.com;
    
    root /var/www/html;
    index index.html;
    
    # Maintenance mode check
    # If /var/www/html/.maintenance exists, serve maintenance page
    if (-f $document_root/.maintenance) {
        set $maintenance_mode 1;
    }
    
    # Allow access to maintenance page itself and static assets
    if ($uri ~ ^/(maintenance\.html|\.well-known)/) {
        set $maintenance_mode 0;
    }
    
    # Allow admin bypass (optional - via secret header or IP)
    # if ($remote_addr ~ ^(10\.|192\.168\.|127\.)) {
    #     set $maintenance_mode 0;
    # }
    
    # Return 503 with maintenance page
    if ($maintenance_mode = 1) {
        return 503;
    }
    
    # Error page for maintenance mode
    error_page 503 @maintenance;
    
    location @maintenance {
        internal;
        rewrite ^(.*)$ /maintenance.html break;
    }
    
    # Normal proxy configuration
    location / {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Alternative: Lua-based maintenance mode (requires nginx lua module)
# More flexible, allows IP whitelist, admin bypass, etc.
# server {
#     listen 80;
#     server_name ctf.com;
#     
#     access_by_lua_block {
#         local maintenance_file = "/var/www/html/.maintenance"
#         local f = io.open(maintenance_file, "r")
#         
#         if f then
#             f:close()
#             
#             -- Allow local IPs
#             local remote_addr = ngx.var.remote_addr
#             if remote_addr:match("^127\.") or 
#                remote_addr:match("^10\.") or 
#                remote_addr:match("^192\.168\.") then
#                 return
#             end
#             
#             -- Check for bypass header (admin secret)
#             local bypass_header = ngx.req.get_headers()["X-Maintenance-Bypass"]
#             if bypass_header == "your-secret-token" then
#                 return
#             end
#             
#             -- Serve maintenance page
#             ngx.status = 503
#             ngx.header["Content-Type"] = "text/html"
#             local mf = io.open("/var/www/html/maintenance.html", "r")
#             if mf then
#                 ngx.say(mf:read("*all"))
#                 mf:close()
#             else
#                 ngx.say("<h1>Maintenance Mode</h1><p>We'll be back soon!</p>")
#             end
#             ngx.exit(ngx.HTTP_SERVICE_UNAVAILABLE)
#         end
#     }
#     
#     location / {
#         proxy_pass http://backend;
#     }
# }
